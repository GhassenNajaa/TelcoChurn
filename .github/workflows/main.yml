name: CI/CD Pipeline MLOps - Docker Build & Push

on:
  push:
    branches:
      - main
      # Ajoutez 'master' ici si jamais vous passez sur cette branche
      # - master 

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout du code (récupère le code et les fichiers DVC)
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 est nécessaire pour récupérer l'historique complet pour DVC
          fetch-depth: 0 

      - name: 2. Connexion à Docker Hub
        uses: docker/login-action@v3
        with:
          # Assurez-vous que DOCKER_USERNAME et DOCKER_PASSWORD sont bien définis dans les secrets
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 3. Définition des Tags Docker (latest, v1, et SHA du commit)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: 177777771/telco-churn-api 
          # Cette section utilise le bon format YAML pour définir plusieurs tags
          tags: |
            type=raw,value=latest,enable=true # Tag pour le dernier build réussi
            type=raw,value=v1,enable=true     # Tag statique pour la version majeure
            type=sha,prefix=,suffix=,enable=true # Tag basé sur le SHA du commit

      - name: 4. Construction et Push de l'Image Docker
        uses: docker/build-push-action@v5
        with:
          context: . 
          push: true
          # Utilise tous les tags générés à l'étape 3
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          file: ./Dockerfile